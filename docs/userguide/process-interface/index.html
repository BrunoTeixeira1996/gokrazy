<!DOCTYPE html>
<html>  <head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>gokrazy process interface / requirements</title>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<link href="/jumbotron-narrow.css" rel="stylesheet">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<style type="text/css">
body {
  font-family: "Open Sans";
}
.table-striped>tr:nth-child(odd){
   background-color:red;
}
</style>
  </head>
<body>
	  <div class="container"><div class="header"><nav>
  <ul class="nav nav-pills pull-right">
      
      
      
      <li role="presentation" class=""><a href="/">Home </a></li>
      
      
      <li role="presentation" class=""><a href="/platforms/">Platforms </a></li>
      
      
      <li role="presentation" class=""><a href="/quickstart/">Quickstart </a></li>
      
      
      <li role="presentation" class=""><a href="/showcase/">Showcase </a></li>
      
      
      <li role="presentation" class=""><a href="/userguide/">Userguide </a></li>
      
      
      <li role="presentation" class=""><a href="https://github.com/gokrazy/gokrazy">Source </a></li>
      
  </ul>
</nav>
<h3 class="text-muted">gokrazy</h3>
</div>

<h1 id="gokrazy-process-interface--requirements">gokrazy process interface / requirements</h1>
<h2 id="process-supervision">Process supervision</h2>
<p><strong>Tip:</strong> You can find the corresponding code in
<a href="https://sourcegraph.com/search?q=context:global+repo:%5Egithub%5C.com/gokrazy/gokrazy%24+type:symbol+%5Esupervise%24&amp;patternType=regexp&amp;case=yes">func <code>gokrazy.supervise</code></a>.</p>
<p>gokrazy’s init process (pid 1) supervises all the binaries the user specified via <code>gokr-packer</code> flags.</p>
<p>More specifically, gokrazy:</p>
<ol>
<li>Starts your binary using Go’s <code>os/exec.Command</code> API.
<ul>
<li><a href="https://manpages.debian.org/unshare.2"><code>unshare(CLONE_NEWNS)</code></a> is used so
that each process operates in its own <a href="https://manpages.debian.org/mount_namespaces.7">mount
namespace</a>.</li>
<li>The <code>stdout</code> and <code>stderr</code> file descriptors are hooked up to a ring buffer and can be viewed via gokrazy’s web interface.</li>
<li>Extra command-line flags or environment variables can be specified using
<a href="/userguide/package-config/">per-package configuration</a>.</li>
</ul>
</li>
<li>When your binary’s process exits, gokrazy restarts it!
<ul>
<li>If the process exits with status code <code>125</code>, gokrazy will stop
supervision. Exiting with status code <code>125</code> when the
<code>GOKRAZY_FIRST_START=1</code> environment variable is set means “don’t start the
program on boot”</li>
</ul>
</li>
</ol>
<h2 id="environment-variables">Environment variables</h2>
<p>gokrazy sets the <code>HOME</code> environment variable to <code>HOME=/perm/&lt;cmd&gt;</code>, where
<code>&lt;cmd&gt;</code> is the name of your binary. For example, <code>tailscale.com/cmd/tailscaled</code>
is started with <code>HOME=/perm/tailscaled</code>.</p>
<p>When your binary is first started, gokrazy sets the <code>GOKRAZY_FIRST_START=1</code>
environment variable.</p>
<h2 id="privilege-dropping--security">Privilege dropping / security</h2>
<p>An easy way to implement privilege dropping in Go is to re-execute the process
with <a href="https://pkg.go.dev/syscall#SysProcAttr">syscall.SysProcAttr</a> fields
set. For example, this is how you would drop privileges to user <code>nobody</code>
(uid/gid 65534):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// mustDropPrivileges re-executes the program in a child process,
</span><span style="color:#75715e">// dropping root privileges to user nobody.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">mustDropPrivileges</span>() {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Getenv</span>(<span style="color:#e6db74">&#34;NTP_PRIVILEGES_DROPPED&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;1&#34;</span> {
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#a6e22e">cmd</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">exec</span>.<span style="color:#a6e22e">Command</span>(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Args</span>[<span style="color:#ae81ff">0</span>])
	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Env</span> = append(<span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Environ</span>(), <span style="color:#e6db74">&#34;NTP_PRIVILEGES_DROPPED=1&#34;</span>)
	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stdout</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stdout</span>
	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Stderr</span> = <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Stderr</span>
	<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">SysProcAttr</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">SysProcAttr</span>{
		<span style="color:#a6e22e">Credential</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">syscall</span>.<span style="color:#a6e22e">Credential</span>{
			<span style="color:#a6e22e">Uid</span>: <span style="color:#ae81ff">65534</span>,
			<span style="color:#a6e22e">Gid</span>: <span style="color:#ae81ff">65534</span>,
		},
	}
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">cmd</span>.<span style="color:#a6e22e">Run</span>())
}
</code></pre></div><p>Examples:</p>
<ul>
<li><a href="https://sourcegraph.com/github.com/gokrazy/gokrazy/-/blob/cmd/ntp/privdrop.go"><code>github.com/gokrazy/gokrazy/cmd/ntp</code></a>
is a rather involved example which retains the CAP_SYS_TIME capability in the
child process</li>
<li><a href="https://sourcegraph.com/github.com/gokrazy/rsync/-/blob/internal/maincmd/namespacing_linux.go"><code>github.com/gokrazy/rsync</code></a> uses Linux
mount namespaces and constructs a file system with read-only bind mounts of
the configured rsync modules</li>
</ul>

      <footer class="footer" style="text-align: center">
        <p>© 2017 gokrazy authors (Michael Stapelberg and contributors)</p>
      </footer>
    </div>
  </body>
</html>
</div>
    </body>
</html>
